 <!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" name="viewport">
    <title>Solo map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  	<link rel="stylesheet" type="text/css" href="src/css/style.css">
    <!-- <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script> -->
    <!-- Swiper and swiper slider -->
    <link rel="stylesheet" href="src/css/idangerous.swiper.css">
    <script defer src="src/script/idangerous.swiper.js"></script>
    <link rel="stylesheet" href="src/css/idangerous.swiper.scrollbar.css">
    <script defer src="src/script/idangerous.swiper.scrollbar.js"></script>
    <!-- FONTS -->
    <link href='http://fonts.googleapis.com/css?family=Raleway:300,400,500' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <!-- Mapbox -->
    <script type="text/javascript" src='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.css' rel='stylesheet' type='text/css'/>    
    <!-- Taffy DB -->
    <script type="text/javascript" src="src/script/taffy-min.js"></script>
    <script type="text/javascript">

      //***********************************************************************
      //***********************Here goes the stuff for the map*****************
      //***********************************************************************
      var kelurahansFusionTableID = "1jdxsdPlAvCNRair4uv2pOwWTzMNtutDdhfXlp9QO";
      var musrenbangFusionTableID = "1yHXZ3Z5yQXl8eEewPUgYSzOvd458RhW9pQ2smFIf";
      var projectFields = ["KELURAHAN", "YEAR", "VOTED", "CATEGORY", "SUBCATEGORY", "UNIQUE_NUMBER", "LEVEL", "PRIORITY", "PROJECT_NAME", "LOCATION", "AGENCY", "PLANNED_BUDGET", "EXECUTED_BUDGET", "IS_IT_EXECUTED", "NOTES"];
      var projectDatabase =  TAFFY();
      var colors = ['#BEC1C4', '#AB8A71', '#F0BC6E', '#F7DE8C']; // More neutral, similar to Kota Kita site
      var originalKelurahanOpacity = 0.7;
      var onHoverKelurahanOpacity = 0.3;
      var activeKelurahanOpacity = 0.1;
      var map;
      var kelurahans = [];
      var projectsArray = [];
      document.addEventListener("DOMContentLoaded", initialize);
/*      google.maps.event.addDomListener(window, 'load', initialize);*/
      var mapStateController = new mapStateController();
      function initialize() {
        L.mapbox.accessToken = 'pk.eyJ1Ijoic3RlcGhlbmtlbm5lZHkiLCJhIjoidjE2aTktdyJ9.gpYsw_JQAEuHlK5rAq0rsw';
          map = L.mapbox.map("map-canvas", 'stephenkennedy.ad4e43ac')
        .setView([-7.566667, 110.816667], 13);

/*        var myOptions = {
          zoom: 13,
          center: new google.maps.LatLng(-7.555974952021982, 110.818951686123),
          disableDefaultUI: true,
          scaleControl: true
        };
        map = new google.maps.Map(document.getElementById('map-canvas'), myOptions);*/
        getKelurahans();
        getProjects();
      }

      function getKelurahans(){
        var query = 'SELECT KELURAHAN, geometry, geometry_pos FROM ' + kelurahansFusionTableID;
        getFusionTablesData(query, "parseKelurahans");
      }

      function mapStateController(){
        var state;
        var possibleStates = {
            Main: 1,
            Kelurahan: 2,
        };
        this.showMain = function(){

        }

        this.onKelurahanMouseOver = function(kelurahanIndex){
            kelurahans[kelurahanIndex].setOpacity(onHoverKelurahanOpacity);
            document.getElementById("kelurahan_name").innerHTML = kelurahans[kelurahanIndex].name;
        }
        this.onKelurahanClick = function(kelurahanIndex){
            //map.panTo(kelurahans[kelurahanIndex].center);
            //map.fitBounds(kelurahans[kelurahanIndex].bounds);
            kelurahans[kelurahanIndex].setOpacity(activeKelurahanOpacity);
        }
        this.onKelurahanMouseOut = function(kelurahanIndex){
          kelurahans[kelurahanIndex].setOpacity(originalKelurahanOpacity);
          document.getElementById("kelurahan_name").innerHTML = "";
        }
        this.showKelurahanProjects = function(kelurahanIndex){

          // Zoom to the current kelurahan

          // Get the info on the Projects for this Kelurahan if it doesn't exist

          // Get the info for the RTs in this kelurahan if it doesn't exist

          // Get the info for the RWs in this kelurahans if it doesn't exist

          // Set the other kelurahans as not active

          // Set this kelurahan as active

          // Turn off all the other kelurahans

          // Make this kelurahan dimmer

          // Show the list of projects

        }
      }

      function parseKelurahans(data){
        var rows = data['rows'];
        for (var i in rows) {
          var newCoordinates = [];
          var kelurahan_name = rows[i][0];
          var center = constructNewPointCoordinates(rows[i][2]['geometry']);
          var geometries = rows[i][1]['geometries'];
          if (geometries) {
            for (var j in geometries) {
              newCoordinates.push(constructNewCoordinates(geometries[j]));
            }
          } else {
            newCoordinates = constructNewCoordinates(rows[i][1]['geometry']);
          }
          kelurahans[i] = new kelurahan(kelurahan_name, newCoordinates, center, i);
        }
        drawKelurahans(kelurahans);
      }

      function kelurahan(name, geometry, center, index) {
        this.name = name;
        this.geometry = geometry;
        this.index = index;
        this.center = center;
        var projects = null;
        var randomnumber = Math.floor(Math.random() * 4);
        this.shapeOptions = {
            color: "#000000",
            opacity: 0.7,
            weight: 1,
            fillColor: colors[randomnumber],
            fillOpacity: originalKelurahanOpacity,
            kelurahan_name : this.name,
            index : this.index
        };
        this.kelurahanShape = new L.polygon(this.geometry, this.shapeOptions);
        //this.bounds = kelurahanShape.getBounds();
        this.drawKelurahan = function() {
          map.addLayer(this.kelurahanShape);
        }
        this.initializeShape = function(){
          this.drawKelurahan();
          this.addListeners();
        }
        this.setOpacity = function(opacity) {
          this.kelurahanShape.setStyle({fillOpacity: 1});
        }
        this.addListeners = function() {
          var that = this;
          this.kelurahanShape.on("click", function(){
              window.alert(that.index);
              //that.setOpacity(onHoverKelurahanOpacity);
              //window.alert(JSON.stringify(this)); 
              mapStateController.onKelurahanClick(that.index);
          });
/*          google.maps.event.addListener(kelurahanShape, 'mouseover', function() {
            mapStateController.onKelurahanMouseOver(this["index"]);
          });
          google.maps.event.addListener(kelurahanShape, 'mouseout', function() {
            mapStateController.onKelurahanMouseOut(this["index"]);
          });
          google.maps.event.addListener(kelurahanShape, 'click', function() {
            mapStateController.onKelurahanClick(this["index"]);
          }); */
        }
      }

      function drawKelurahans(kelurahans) {
        this.kelurahans = kelurahans;
        shuffleArray = [];
        for (var i=0; i < kelurahans.length; i++){
          shuffleArray[i] = i;
        }
        shuffleArray = shuffle(shuffleArray);
        i = 0;
        var interval = setInterval(function(){
          if (i < kelurahans.length){
            kelurahans[shuffleArray[i]].initializeShape();
            i++;
          } else{
            clearInterval(interval);
          }
        }, 50)
      }

      function drawMap(data) {

      }

      function constructNewCoordinates(polygon) {
        var newCoordinates = [];
        var coordinates = polygon['coordinates'][0];
        for (var i in coordinates) {
          newCoordinates.push(new L.LatLng(coordinates[i][1], coordinates[i][0]));
        }
        return newCoordinates;
      }

      function constructNewPointCoordinates(originalPoint) {
        var pointCoordinates;
        var pointFromSource = originalPoint["coordinates"];
        pointCoordinates = new L.LatLng(pointFromSource[1], pointFromSource[0]);
        return pointCoordinates;
      }

      // Fisherâ€“Yates shuffle
      function shuffle(array) {
        var counter = array.length, temp, index;
        // While there are elements in the array
        while (counter > 0) {
          // Pick a random index
          index = Math.floor(Math.random() * counter);
          // Decrease counter by 1
          counter--;
          // And swap the last element with it
          temp = array[counter];
          array[counter] = array[index];
          array[index] = temp;
        }
        return array;
      }
      
    /*  google.maps.Polygon.prototype.getBounds = function() {
          var bounds = new google.maps.LatLngBounds();
          var paths = this.getPaths();
          var path;        
          for (var i = 0; i < paths.getLength(); i++) {
              path = paths.getAt(i);
              for (var ii = 0; ii < path.getLength(); ii++) {
                  bounds.extend(path.getAt(ii));
              }
          }
          return bounds;
      }*/
      //***********************************************************************
      //***************Here goes the stuff for the swipe and info**************
      //***********************************************************************
      function getProjects() {
        columnNames = getWhatToGet(projectFields);
        var query = 'SELECT ' + columnNames + '  FROM ' + musrenbangFusionTableID;
        getFusionTablesData(query, "parseProjects");
      }

      function parseProjects(data){
        var rows = data['rows'];
        // Filling a TaffyDB with the information of the projects.
        for (var j in rows){
          var tempObj = {};
          tempObj["INDEX"] = j;
          for (var i=0; i < projectFields.length; i++){
            tempObj[projectFields[i]] = rows[j][i];
          }
          projectDatabase.insert(tempObj);
        }
        fillProjectCards("SUMBER","2012",2014);
      }


      function projectCard(project){
        var div = document.createElement("div");
        var category = document.createTextNode(project.CATEGORY);
        var subcategory = document.createTextNode(project.SUBCATEGORY);
        var name = document.createTextNode(project.PROJECT_NAME);
        div.appendChild(category);
        div.appendChild(subcategory);
        div.appendChild(name);
        this.getView = function(){
          return div;
        };
      }
      function fillProjectCards(kelurahan, startYear, endYear){
        var swiperWrapper = document.getElementById("swiper-wrapper");
        var projectCardArray = [];
        var projectsToShow = projectDatabase({KELURAHAN : kelurahan, YEAR : startYear}).get();
        for (var i=0; i < projectsToShow.length; i++){
          var swiperSlide = document.createElement('div');
          swiperSlide.className = 'swiper-slide';
          projectCardArray[i] = new projectCard(projectsToShow[i]);
          swiperSlide.appendChild(projectCardArray[i].getView());
          swiperWrapper.appendChild(swiperSlide);
        }
        createSwiperInterface();
      }
      function createSwiperInterface(){
        var mySwiper = new Swiper('.swiper-container',{
          //Your options here:
          mode:'vertical',
          pagination: '.pagination',
          paginationClickable: true,
          loop: true,
          grabCursor: true,
          createPagination: true,
          autoResize: true,
          resizeReInit: true,
          slidesPerView: 10,
          //etc..
          scrollbar: {
          container : '.swiper-scrollbar',
          draggable : true,
          hide: false,
          snapOnRelease: true
          }
        });
      }
      //***********************************************************************
      //*************Here goes the stuff related to Fusion Tables**************
      //***********************************************************************
      function getFusionTablesData(query, callback){
        var script = document.createElement('script');
        var url = ['https://www.googleapis.com/fusiontables/v1/query?'];
        url.push('sql=');
        var encodedQuery = encodeURIComponent(query);
        url.push(encodedQuery);
        url.push('&callback=' + callback);
        url.push('&key=AIzaSyAhX7a_0uyiA8DfW-4XJ6ZN_ay8GkAGrz0');
        script.src = url.join('');
        var body = document.getElementsByTagName('body')[0];
        body.appendChild(script);
      }  
      function getWhatToGet(columnNames){
        var whatToGet = "";
        for (var i = 0; i < columnNames.length; i++){
          whatToGet = whatToGet + columnNames[i] + ", ";
        }
        whatToGet = whatToGet.substring(0, whatToGet.length - 2);
        return whatToGet;
      }    
    </script>
  </head>
  <body>
    <div id="info_container">
      <div class="swiper-container">
        <div class="swiper-wrapper" id="swiper-wrapper"></div>
        <div class="pagination"></div>
        <div class="swiper-scrollbar"></div>
      </div>    
    </div>
    <div id="solo_map_container">
      <div id="map-canvas"></div>
      <div id="info_box">
        <h1 id="kelurahan_title">Solo</h1>
        <p id="kelurahan_name"></p>
      </div>
    </div>
  </body>
</html>