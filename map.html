<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Solo map</title>
      <style type="text/css">
    #map-canvas {
      height: 500px;
      width: 600px;
    }
    body {
      font-family: 'Raleway', Helvetica, Arial, sans-serif;
      font-weight: 300;
      text-transform: uppercase;
      letter-spacing: 5px;
      font-size: 1.75em;
      color: black;
    }
    </style>
    <script type="text/javascript"
      src="https://maps.google.com/maps/api/js?sensor=false"></script>
    <!-- Raleway font -->
    <link href='http://fonts.googleapis.com/css?family=Raleway:300,400,500' rel='stylesheet' type='text/css'>  
    <!-- stamen maps library -->
    <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.1.3"></script>
    <script type="text/javascript">
      var kelurahansFusionTableID = "1jdxsdPlAvCNRair4uv2pOwWTzMNtutDdhfXlp9QO";
      //var colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00'];
      //var colors = ['#FE0055', '#0E7AFC', '#FF9C00', '#7CFE00'];
      var colors = ['#04AF44', '#5012A3', '#F1DC06', '#F12F06'];
      var map;
      var kelurahans = [];
      google.maps.event.addDomListener(window, 'load', initialize);
      function initialize() {
        var stamen_layer = "terrain"; // Kind of Stamen map to be rendered
        var myOptions = {
          zoom: 13,
          center: new google.maps.LatLng(-7.562951899239144, 110.82495983431636),
          // mapTypeId: stamen_layer,
          disableDefaultUI: true,
          scaleControl: true /*, 
          mapTypeControlOptions: {
            mapTypeIds: [stamen_layer]
          }*/
        };
        map = new google.maps.Map(document.getElementById('map-canvas'), myOptions);
        getKelurahans();
      }

      function getKelurahans(){
        var script = document.createElement('script');
        var url = ['https://www.googleapis.com/fusiontables/v1/query?'];
        url.push('sql=');
        var query = 'SELECT KELURAHAN, geometry, geometry_pos FROM ' + kelurahansFusionTableID;
        var encodedQuery = encodeURIComponent(query);
        url.push(encodedQuery);
        url.push('&callback=parseKelurahans');
        url.push('&key=AIzaSyAm9yWCV7JPCTHCJut8whOjARd7pwROFDQ');
        script.src = url.join('');
        var body = document.getElementsByTagName('body')[0];
        body.appendChild(script);
      }

      function parseKelurahans(data){
        var rows = data['rows'];
        for (var i in rows) {
          var newCoordinates = [];
          var kelurahan_name = rows[i][0];
          var center = constructNewPointCoordinates(rows[i][2]['geometry']);
          var geometries = rows[i][1]['geometries'];
          if (geometries) {
            for (var j in geometries) {
              newCoordinates.push(constructNewCoordinates(geometries[j]));
            }
          } else {
            newCoordinates = constructNewCoordinates(rows[i][1]['geometry']);
          }
          kelurahans[i] = new kelurahan(kelurahan_name, newCoordinates, center, i);
        }
        drawKelurahans(kelurahans);
      }

      function kelurahan(name, geometry, center, index) {
        this.name = name;
        this.geometry = geometry;
        this.index = index;
        this.center = center;
        var projects = null;
        var randomnumber = Math.floor(Math.random() * 4);
        var kelurahanShape = new google.maps.Polygon({
            paths: this.geometry,
            strokeColor: "#000000",
            strokeOpacity: 0.7,
            strokeWeight: 1.5,
            fillColor: colors[randomnumber],
            fillOpacity: 0.5,
            kelurahan_name : this.name,
            index : this.index
        });
        this.showProjects = function() {
          if (!projects){
            this.projects = getProjects(name);
          }
          showProjectsOnMap(this.projects)
        }
        this.drawKelurahan = function() {
          kelurahanShape.setMap(map);
        }
        this.initializeShape = function(){
          this.drawKelurahan();
          this.addListeners();
        }
        this.addListeners = function() {
          google.maps.event.addListener(kelurahanShape, 'mouseover', function() {
            this.setOptions({fillOpacity: 1});
            document.getElementById("kelurahan_name").innerHTML = this["kelurahan_name"];
          });
          google.maps.event.addListener(kelurahanShape, 'mouseout', function() {
            this.setOptions({fillOpacity: 0.3});
            document.getElementById("kelurahan_name").innerHTML = "";
          });
          google.maps.event.addListener(kelurahanShape, 'click', function() {
            this.setOptions({fillOpacity: 0.1});
            map.panTo(center);
            map.fitBounds(kelurahanShape.getBounds());
          }); 
        }
      }

      function drawKelurahans(kelurahans) {
        this.kelurahans = kelurahans;
        shuffleArray = [];
        for (var i=0; i < kelurahans.length; i++){
          shuffleArray[i] = i;
        }
        shuffleArray = shuffle(shuffleArray);
        i = 0;
        var interval = setInterval(function(){
          if (i < kelurahans.length){
            kelurahans[shuffleArray[i]].initializeShape();
            i++;
          } else{
            clearInterval(interval);
          }
        }, 50)

        // for (var i=0; i < kelurahans.length; i++){
        //   drawKelurahan(kelurahans[i]);
        // }
      }

      function showProjectsOnMap(projects) {

      }

      function getProjects(kelurahan_name) {
        var projects
        return projects
      }

      function drawMap(data) {

      }

      function constructNewCoordinates(polygon) {
        var newCoordinates = [];
        var coordinates = polygon['coordinates'][0];
        for (var i in coordinates) {
          newCoordinates.push(new google.maps.LatLng(coordinates[i][1], coordinates[i][0]));
        }
      return newCoordinates;
      }

      function constructNewPointCoordinates(originalPoint) {
        var pointCoordinates;
        var pointFromSource = originalPoint["coordinates"];
        pointCoordinates = new google.maps.LatLng(pointFromSource[1], pointFromSource[0]);
        return pointCoordinates;
      }

      // Fisherâ€“Yates shuffle
      function shuffle(array) {
        var counter = array.length, temp, index;
        // While there are elements in the array
        while (counter > 0) {
          // Pick a random index
          index = Math.floor(Math.random() * counter);
          // Decrease counter by 1
          counter--;
          // And swap the last element with it
          temp = array[counter];
          array[counter] = array[index];
          array[index] = temp;
        }
        return array;
      }
      
      google.maps.Polygon.prototype.getBounds = function() {
          var bounds = new google.maps.LatLngBounds();
          var paths = this.getPaths();
          var path;        
          for (var i = 0; i < paths.getLength(); i++) {
              path = paths.getAt(i);
              for (var ii = 0; ii < path.getLength(); ii++) {
                  bounds.extend(path.getAt(ii));
              }
          }
          return bounds;
      }
    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
    <div id="info_box">
      <h1 id="kelurahan_title">Kelurahan: </h1>
      <p id="kelurahan_name"></p>
    </div>
  </body>
</html>